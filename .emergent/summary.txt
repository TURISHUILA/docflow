<analysis>**original_problem_statement:**
El usuario necesita una aplicaci√≥n inteligente para gestionar documentos de pago, que permita cargar, clasificar con IA, extraer datos, correlacionar documentos coincidentes y generar un PDF consolidado.

**PRODUCT REQUIREMENTS:**
1.  **Carga de Documentos:** Carga en bloque de documentos (PDF, JPG, PNG) en carpetas espec√≠ficas.
2.  **Clasificaci√≥n y Extracci√≥n de Datos (IA):** Identificar el tipo de documento y extraer informaci√≥n clave (valores, fechas, tercero, NIT, etc.).
3.  **Correlaci√≥n Inteligente:** La IA debe agrupar documentos que coincidan por valor, tercero, fecha y concepto.
4.  **Generaci√≥n de PDF:** Unir los documentos correlacionados en un √∫nico PDF con un orden espec√≠fico.
5.  **Roles y Seguridad:** M√∫ltiples roles de usuario (Admin, Operativo, Auditor) y registro de acciones.
6.  **UX/UI Mejorada:** Dise√±o limpio con flujos de trabajo claros y estados visuales (colores para pendiente, validado, analizado).
7.  **Formato de Nombre de Archivo:** El PDF generado debe nombrarse .
8.  **Gesti√≥n de Documentos:** Permitir la validaci√≥n manual por carpeta antes del an√°lisis de la IA.
9.  **Gesti√≥n de Lotes:** Crear lotes a partir de sugerencias, re-analizar grupos para encontrar documentos faltantes y crear todos los lotes en masa.
10. **Gesti√≥n de Archivos:** Aumentar el l√≠mite de carga, detectar duplicados y limpiar la vista de documentos que ya est√°n en un lote.
11. **Estabilidad:** El proceso de an√°lisis de la IA debe ser robusto y no colapsar el servidor al procesar muchos documentos.
12. **Despliegue:** La aplicaci√≥n debe estar desplegada y funcional en un entorno de producci√≥n.

**User's preferred language**: Spanish

**what currently exists?**
Una aplicaci√≥n full-stack (FastAPI + React + MongoDB) completamente funcional y desplegada en producci√≥n. La aplicaci√≥n implementa un flujo de trabajo sofisticado para la gesti√≥n de documentos:
1.  **Carga:** El usuario sube hasta 70 archivos por carpeta, con detecci√≥n de duplicados.
2.  **Validaci√≥n:** El usuario valida manualmente los archivos de cada una de las 4 carpetas. La UI muestra estados con c√≥digos de color (üî¥ Pendiente, üü¢ Validado).
3.  **An√°lisis:** Un bot√≥n ANALIZAR CON IA (que se activa cuando todo est√° validado) procesa los documentos en lotes para evitar que el servidor se caiga, extrayendo datos con Gemini.
4.  **Correlaci√≥n:** En la p√°gina Lotes, la IA sugiere grupos de documentos correlacionados. Se implementaron botones para RE-ANALIZAR (global y por grupo) y CREAR TODOS LOS LOTES.
5.  **Gesti√≥n:** Se pueden eliminar PDFs consolidados y los documentos ya agrupados se ocultan de la vista principal para mantenerla limpia.

Sin embargo, existe un error cr√≠tico en producci√≥n que impide que se muestren las sugerencias de correlaci√≥n.

**Last working item**:
- Last item agent was working: Diagnosticando por qu√© no aparecen sugerencias de correlaci√≥n en la p√°gina Lotes del entorno de producci√≥n, a pesar de que hay 450 documentos analizados con datos extra√≠dos.
- Status: BLOCKED
- Agent Testing Done: Y (Localmente)
- Which testing method agent to use? Se requiere que el usuario realice una prueba manual en el entorno de producci√≥n despu√©s de que se complete el redespliegue.
- User Testing Done: N

**All Pending/In progress Issue list**:
- Issue 1: La p√°gina de Lotes en producci√≥n no muestra ninguna sugerencia de correlaci√≥n. (P0)

Issues Detail:
- Issue 1:
  - **Description:** El endpoint  devuelve una lista vac√≠a en producci√≥n. El agente ha diagnosticado que el problema se debe a una discrepancia entre el c√≥digo desplegado y la versi√≥n m√°s reciente en el espacio de trabajo. El c√≥digo de producci√≥n utiliza una comparaci√≥n de Enum (), que falla porque el valor en la base de datos es una cadena de texto ().
  - **Attempted fixes:** El agente corrigi√≥ el c√≥digo en el espacio de trabajo local para utilizar comparaciones de cadenas de texto. Ejecut√≥ un script que simulaba la l√≥gica corregida con los datos de producci√≥n y confirm√≥ que se encontrar√≠an **107 correlaciones**.
  - **Next debug checklist:** El problema ya no es de c√≥digo, sino de despliegue. El c√≥digo corregido debe ser desplegado en el entorno de producci√≥n.
  - **Why fix this issue and what will be achieved with the fix?** Este es el n√∫cleo de la funcionalidad de la aplicaci√≥n. Solucionarlo permitir√° al usuario ver las sugerencias de la IA y generar los PDFs consolidados.
  - **Status:** BLOCKED (Esperando la acci√≥n del usuario para redesplegar la aplicaci√≥n).
  - **Is recurring issue?** N
  - **Should Test frontend/backend/both after fix?** backend
  - **Blocked on other issue:** None

**In progress Task List**:
None

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - **P0:** Guiar al usuario para que vuelva a desplegar la aplicaci√≥n. Es la √∫nica forma de que las correcciones de c√≥digo (especialmente la del bug de Enum vs. string) se apliquen al entorno de producci√≥n y se resuelva el problema de las correlaciones.

- **Future Tasks:**
  - Implementar una opci√≥n para regenerar PDFs antiguos con el nuevo formato de nombre de archivo.

**Completed work in this session**
- **Flujo de Trabajo Completamente Redise√±ado:** Se implement√≥ el flujo , con estados visuales claros (üî¥, üü¢, üîµ).
- **Estabilidad del An√°lisis Mejorada:** Se refactoriz√≥ el an√°lisis masivo de documentos para que se procesen en lotes peque√±os, evitando que el servidor se caiga por tiempos de espera prolongados.
- **Formato de Nombre de PDF:** Se implement√≥ el formato de nombre de archivo .
- **Mejoras en la Gesti√≥n de Lotes:** Se a√±adieron botones para RE-ANALIZAR (global y por grupo) y CREAR TODOS LOS LOTES con barra de progreso.
- **Mejoras en la Carga:** Se aument√≥ el l√≠mite de carga a 70 archivos y se a√±adi√≥ detecci√≥n de duplicados.
- **Limpieza de UI:** Los documentos que ya pertenecen a un lote se ocultan de la vista principal Documentos.
- **Funcionalidad de Eliminaci√≥n:** Se a√±adi√≥ la capacidad de eliminar PDFs consolidados y se cre√≥ un endpoint para limpiar toda la base de datos.
- **Despliegue a Producci√≥n:** Se guio al usuario a trav√©s del despliegue inicial de la aplicaci√≥n.
- **Diagn√≥stico Cr√≠tico:** Se identific√≥ que los entornos de  y  tienen bases de datos y versiones de c√≥digo separadas, y se diagnostic√≥ el bug exacto (Enum vs. string) que impide el funcionamiento en producci√≥n.

**Earlier issues found/mentioned but not fixed**
- Issue 1: La previsualizaci√≥n del PDF en el iframe a veces no se carga.
  - Debug checklist:
    1.  Verificar los headers  y .
    2.  Investigar la compatibilidad del  URL en diferentes navegadores.
    3.  Considerar usar una librer√≠a como .
  - Why to solve this issue and what will be achieved with this? Mejora la UX al permitir la visualizaci√≥n directa del PDF.
  - Should Test frontend/backend/both after fix: frontend
  - Is recurring issue? Y

**Known issue recurrence from previous fork**
- N/A

**Code Architecture**


**Key Technical Concepts**
- **Backend:** FastAPI
- **Frontend:** React, Tailwind CSS, Shadcn UI
- **Database:** MongoDB
- **AI Integration:** Gemini ()
- **Procesamiento en Lotes (Chunking):** El frontend ahora llama a la API de an√°lisis en lotes secuenciales para evitar timeouts del servidor, mostrando el progreso al usuario.
- **Diferencia de Entornos:** Existe una separaci√≥n estricta entre el entorno de  (local) y . Los cambios de c√≥digo requieren un redespliegue para afectar a producci√≥n.

**key DB schema**
- : 
- : 

**changes in tech stack**
- Ninguno.

**All files of reference**
- : Modificado extensamente para a√±adir los nuevos endpoints (, , , ), cambiar la l√≥gica de an√°lisis a lotes, y corregir el bug de Enum vs. string.
- : Pr√°cticamente reescrito para implementar el nuevo flujo de trabajo de validaci√≥n y an√°lisis, con nuevos estados, botones y l√≥gica de procesamiento en lotes.
- : Modificado significativamente para a√±adir los botones CREAR TODOS (con barra de progreso) y RE-ANALIZAR por grupo.
- : Actualizado para aumentar el l√≠mite de archivos a 70 y manejar los mensajes de duplicados.
- : Actualizado para a√±adir la funcionalidad de eliminar PDFs.

**Areas that need refactoring**:
-  es ahora extremadamente grande. Se recomienda encarecidamente refactorizarlo, dividiendo las rutas y la l√≥gica de negocio en m√≥dulos separados para mejorar la mantenibilidad.

**key api endpoints**
- : Valida todos los documentos en una carpeta espec√≠fica.
- : Inicia el an√°lisis de IA para los documentos validados (ahora procesa en lotes peque√±os).
- : Sugiere lotes correlacionados (endpoint que falla en producci√≥n).
- : Re-analiza un grupo y busca nuevos documentos coincidentes.
- : Crea lotes y PDFs para todas las sugerencias de la IA.
- : Elimina todos los documentos, lotes y PDFs.
- : Elimina un PDF consolidado espec√≠fico.

**Critical Info for New Agent**
- **ACCI√ìN M√ÅS IMPORTANTE:** El usuario **DEBE REDESPLEGAR** la aplicaci√≥n. El c√≥digo en el espacio de trabajo est√° corregido, pero el entorno de producci√≥n tiene una versi√≥n antigua y con errores. Sin un redespliegue, la funcionalidad principal de la aplicaci√≥n (correlaci√≥n de lotes) no funcionar√°.
- **Diagn√≥stico del Bug:** El error en producci√≥n es una comparaci√≥n de un Enum de Python con un valor de cadena de texto en la base de datos. Esto ya est√° solucionado en el c√≥digo local.
- **Separaci√≥n de Entornos:** Recuerda siempre que  y  son completamente independientes (c√≥digo y base de datos). Las pruebas locales o en  no reflejan el estado de  a menos que se redespliegue.

**documents and test reports created in this job**
- Ninguno relevante para el estado actual.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Sugiere que el bot√≥n VALIDAR debe estar fijo en cada carpeta y que los archivos ya correlacionados deben ser eliminados/ocultados. (COMPLETED)
2.  **Agent:** Implementa los cambios: bot√≥n VALIDAR fijo y oculta los documentos en lotes de la vista principal.
3.  **User:** Reporta error al analizar documentos en producci√≥n. (IN PROGRESS)
4.  **Agent:** Diagnostica que el an√°lisis masivo est√° sobrecargando el servidor. Refactoriza el proceso para analizar en lotes peque√±os.
5.  **User:** El error persiste. (IN PROGRESS)
6.  **Agent:** Diagnostica un problema con la librer√≠a de IA, lo prueba en aislamiento y confirma que la funci√≥n de an√°lisis funciona. Finalmente, se da cuenta de que la base de datos local y de producci√≥n est√°n separadas y vac√≠as localmente.
7.  **User:** Reporta que no se generan lotes. (IN PROGRESS)
8.  **Agent:** Verifica la base de datos de producci√≥n, encuentra 450 documentos analizados pero 0 sugerencias. Identifica que es un problema en el algoritmo de correlaci√≥n.
9.  **Agent:** Ejecuta un script localmente y confirma que la l√≥gica de correlaci√≥n S√ç encuentra 107 grupos. Identifica el bug final: el c√≥digo en producci√≥n usa una comparaci√≥n de Enum vs. string que falla.
10. **User:** Quiere que las 107 correlaciones se vean. (PENDING - BLOCKED ON DEPLOY)

**Project Health Check:**
- **Broken:** La funcionalidad principal de correlaci√≥n en el entorno de producci√≥n est√° rota debido a un bug en el c√≥digo desplegado.
- **Mocked:** None.

**3rd Party Integrations**
- **Gemini ()** ‚Äî uses Emergent LLM Key.

**Testing status**
- Testing agent used after significant changes: NO (para la √∫ltima correcci√≥n cr√≠tica).
- Troubleshoot agent used after agent stuck in loop: NO.
- Test files created: N/A
- Known regressions: La funcionalidad de  est√° rota en producci√≥n.

**Credentials to test flow:**
- **Email:** 
- **Password:** 

**What agent forgot to execute**
El agente diagnostic√≥ el problema de manera excelente. No olvid√≥ ejecutar nada, sino que lleg√≥ al l√≠mite de lo que puede hacer sin una acci√≥n del usuario (redesplegar la aplicaci√≥n).</analysis>
